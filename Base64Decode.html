<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" class="h-full leading-none">
<head>
	<meta charset="utf-8" />
	<title>Décodage Base64</title>
	<link rel="shortcut icon" type="image/png" href="favicon.png"/>
	<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
	<script src="https://cdn.tailwindcss.com"></script>
	<script>
		tailwind.config = {
			theme: {
				extend: {
					colors: {
						tomato: '#e74c3c',
					}
				}
			}
		}
	</script>
	<style>
		#excel-preview table {
			border-collapse: collapse;
			margin-top: 1rem;
			font-family: sans-serif;
		}
		#excel-preview td, #excel-preview th {
			border: 1px solid #ccc;
			padding: 4px 8px;
		}
		#excel-preview .bold { font-weight: bold; }
		#excel-preview .italic { font-style: italic; }
		#excel-preview .align-left { text-align: left; }
		#excel-preview .align-center { text-align: center; }
		#excel-preview .align-right { text-align: right; }		
	</style>
</head>
<body class="h-full flex flex-col flex-nowrap p-1">
	<header class="grow-0 flex flex-row space-x-3 ">
		<h1 class="text-lg">Chargement contenu en Base64</h1>
		<button id="run" class="appearance-none border-none flex items-center justify-center px-4 py-2 bg-tomato text-white rounded hover:bg-red-600 transition text-sm"><span class="leading-none">Run</span></button>
	</header>
	<header class="grow-0 flex flex-row py-1 space-x-3 items-baseline">
		<label for="bulletin"><span>Base64 : </span></label>
		<input class="border-2 flex-grow" id="base64input" type="input"/>
	</header>
	<main class="grow flex flex-row flex-nowrap justify-between space-x-3">
		<object style="display: none;" class="w-full h-full border-2" id="pdf-preview" type="application/pdf"></object>
		<div style="display: none;" id="text-preview" class="max-w-full overflow-x-auto border-2">
			<pre id="text-content" class="whitespace-pre font-mono text-sm"></pre>
		</div>
		<div style="display: none;" id="excel-preview" class="max-w-full overflow-x-auto border-2">
		</div>
	</main>
	<script type="module">
		function isBase64PDF(base64String) {
			return base64String.substring(0, 4) === 'JVBER';
		}
		function isBase64Excel(base64String) {
			console.log('isBase64Excel', base64String.substring(0, 5), base64String.substring(0, 5) === 'PD94b');
			return base64String.substring(0, 5) === 'PD94b';
		}
		function base64ToText(base64String) {
			// Étape 1 : décoder Base64 vers une chaîne binaire (ASCII)
			const binaryString = atob(base64String);
			// Étape 2 : convertir la chaîne binaire en tableau d’octets
			const byteArray = Uint8Array.from(binaryString, char => char.charCodeAt(0));
			// Étape 3 : décoder les octets en texte UTF-8
			const decoder = new TextDecoder('utf-8');
			return decoder.decode(byteArray);
		}
		function excelToHTML(base64) {
			const parser = new DOMParser();
			const xmlDoc = parser.parseFromString(base64ToText(base64), "text/xml");

			// === Étape 1 : Styles ===
			const styleMap = {};
			const styles = xmlDoc.querySelectorAll("Style");

			styles.forEach(style => {
				const id = style.getAttribute("ss:ID");
				const font = style.querySelector("Font");
				const alignment = style.querySelector("Alignment");
				const interior = style.querySelector("Interior");

				const styleProps = {
					classList: [],
					style: []
				};

				if (font) {
					if (font.getAttribute("ss:Bold") === "1") styleProps.classList.push("bold");
					if (font.getAttribute("ss:Italic") === "1") styleProps.classList.push("italic");
					if (font.getAttribute("ss:Color")) {
						styleProps.style.push(`color: ${font.getAttribute("ss:Color")}`);
					}
				}

				if (alignment) {
					const horiz = alignment.getAttribute("ss:Horizontal");
					if (horiz) {
						styleProps.classList.push("align-" + horiz.toLowerCase());
					}
				}

				if (interior && interior.getAttribute("ss:Color")) {
					const bgColor = interior.getAttribute("ss:Color");
					styleProps.style.push(`background-color: ${bgColor}`);
				}

				styleMap[id] = styleProps;
			});

			// === Étape 2 : Lecture des données ===
			const worksheet = xmlDoc.querySelector("Worksheet");
			const rows = worksheet.querySelectorAll("Table > Row");

			let html = "<table><tbody>";

			rows.forEach(row => {
				html += "<tr>";
				const cells = row.querySelectorAll("Cell");

				cells.forEach(cell => {
					const data = cell.querySelector("Data");
					const text = data?.textContent || "";
					const styleID = cell.getAttribute("ss:StyleID");
					const props = styleMap[styleID] || { classList: [], style: [] };

					const classAttr = props.classList.join(" ");
					const styleAttr = props.style.join("; ");

					// Gestion des cellules fusionnées (colspan)
					const mergeAcross = cell.getAttribute("ss:MergeAcross");
					const colspan = mergeAcross ? parseInt(mergeAcross, 10) + 1 : 1;

					html += `<td class="${classAttr}" style="${styleAttr}" colspan="${colspan}">${text}</td>`;
				});

				html += "</tr>";
			});

			html += "</tbody></table>";
			return html;
		}		
		function updatePreview(content) {
			const pdfPreview = document.querySelector('#pdf-preview');
			const textPreview = document.querySelector('#text-preview');
			const excelPreview = document.querySelector('#excel-preview');
			pdfPreview.style.display = 'none';
			textPreview.style.display = 'none';
			excelPreview.style.display = 'none';
			if (isBase64PDF(content)) {
				pdfPreview.data = "data:application/pdf;base64," + content;
				pdfPreview.style.display = 'block';
			} else if (isBase64Excel(content)) {
				const htmlContent = excelToHTML(content);
				excelPreview.innerHTML = htmlContent;
				excelPreview.style.display = 'block';
			} else {
				const textContent = document.querySelector('#text-content');
				textContent.textContent = base64ToText(content);
				textPreview.style.display = 'block';
			}
		}
		const base64Input = document.querySelector('#base64input');
		base64Input.addEventListener('paste', (event) => {
			updatePreview((event.clipboardData || window.clipboardData).getData('text'));
		});
		base64Input.addEventListener('input', (event) => {
			updatePreview(base64Input.value);
		});
		const run = document.querySelector('#run');
		run.addEventListener('click', async (event) => {
			updatePreview(base64Input.value);
		});
	</script>
</body>
</html>